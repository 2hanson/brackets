#!/bin/bash

# This script takes the Brackets source from src and builds a minified version in the dist
# folder. It concatenates and minifies the JS and (most of) the CSS, and copies over various other
# source files that are actually required at runtime, as well as extensions.

BRACKETS=`dirname $0`/..
BUILD=$BRACKETS/build
DIST=$BRACKETS/dist
SRC=$BRACKETS/src

rm -rf $DIST
mkdir $DIST

rm -rf $DIST/tmp
mkdir $DIST/tmp

echo "require..."
$BUILD/node_modules/requirejs/bin/r.js -o \
    baseUrl="$SRC" \
    out="$DIST/tmp/brackets.require.js" \
    optimize="none" \
    optimizeCss="none" \
    useStrict="true" \
    name="brackets" \
    include="thirdparty/require"

echo "uglify..."
cat $SRC/utils/WebViewShim.js \
    $SRC/thirdparty/jquery-1.7.js \
    $SRC/thirdparty/CodeMirror2/lib/codemirror.js \
    $SRC/thirdparty/CodeMirror2/lib/util/dialog.js \
    $SRC/thirdparty/CodeMirror2/lib/util/searchcursor.js \
    $SRC/thirdparty/CodeMirror2/lib/util/search.js \
    $DIST/tmp/brackets.require.js \
  | $BUILD/node_modules/uglify-js/bin/uglifyjs \
  > $DIST/brackets.min.js
  
echo "styles..."
mkdir $DIST/styles
$BUILD/node_modules/less/bin/lessc -x $SRC/styles/brackets.less > $DIST/tmp/brackets.less.css

# HACK: need to include codemirror.css here because the @import in the catted file doesn't work
# since it's not at the beginning of the file.
cat $SRC/thirdparty/CodeMirror2/lib/codemirror.css \
    $SRC/thirdparty/CodeMirror2/lib/util/dialog.css \
    $SRC/styles/quiet-scrollbars.css \
    $DIST/tmp/brackets.less.css \
  > $DIST/styles/brackets.min.css
  
# HACK: jsTree currently insists on loading this (empty) CSS file separately at runtime.
cp $SRC/styles/jsTreeTheme.css $DIST/styles

echo "assets..."
cp -R $SRC/styles/fonts $SRC/styles/images $DIST/styles

echo "index..."
sed '/!START!/,/!END!/ c\
    <link rel="stylesheet" href="styles/brackets.min.css">\
    <script src="brackets.min.js"></script>\
' < $SRC/index.html \
  > $DIST/index.html
  
echo "extensions..."
cp -R $SRC/extensions $DIST

echo "misc..."
# TODO: should have a cleaner way to organize files that need to be copied over
mkdir -p $DIST/LiveDevelopment/Inspector
cp $SRC/LiveDevelopment/Inspector/Inspector.json $DIST/LiveDevelopment/Inspector

rm -rf $DIST/tmp
echo "done"
